id: postgres_procedure
namespace: demo.kestra

tasks:
  
  - id: create_table
    type: io.kestra.plugin.jdbc.postgresql.Query
    sql: |
      drop table if exists accounts;

      create table accounts (
          id int generated by default as identity,
          name varchar(100) not null,
          balance dec(15,2) not null,
          primary key(id)
      );

      insert into accounts(name,balance)
      values('Bob',10000);

      insert into accounts(name,balance)
      values('Alice',10000);
  
  - id: query
    type: io.kestra.plugin.jdbc.postgresql.Query
    store: true
    sql: |
      SELECT * FROM accounts;

  - id: create_procedure
    type: io.kestra.plugin.jdbc.postgresql.Query
    sql: |
      create or replace procedure transfer(
        sender int,
        receiver int, 
        amount dec
      )
      language plpgsql    
      as $$
      begin
          -- subtracting the amount from the sender's account 
          update accounts 
          set balance = balance - amount 
          where id = sender;

          -- adding the amount to the receiver's account
          update accounts 
          set balance = balance + amount 
          where id = receiver;

          commit;
      end;$$

  - id: call_procedure
    type: io.kestra.plugin.jdbc.postgresql.Query
    sql: call transfer(1,2,1000);


  - id: query_all
    type: io.kestra.plugin.jdbc.postgresql.Query
    store: true
    sql: |
      SELECT * FROM accounts;

taskDefaults:
  - type: io.kestra.plugin.jdbc.postgresql.Query
    values:
      url: jdbc:postgresql://postgres:5432/kestra
      username: kestra
      password: k3str4
  